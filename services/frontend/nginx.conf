# Minimal nginx config for React SPA
server {
    listen 80;
    server_name localhost;
    root /usr/share/nginx/html;
    index index.html;
    
    # ============================================
    # COMMENTED OUT: DNS Resolver Approach
    # ============================================
    # WHY COMMENTED: Nginx was still trying to resolve api-gateway at startup
    # even with resolver directive. This caused "host not found" errors.
    # The resolver approach works, but nginx needs the variable in proxy_pass
    # AND the resolver must be in the server block (not location block).
    #
    # ORIGINAL CODE:
    # resolver 10.152.183.10 valid=10s;
    # resolver_timeout 5s;
    #
    # ============================================
    # WORKING FIX: Use resolver with variable in proxy_pass
    # ============================================
    # This forces DNS resolution at request time, not startup
    # DNS IP: 10.152.183.10 (kube-dns service in MicroK8s)
    # valid=10s: Cache DNS results for 10 seconds
    resolver 10.152.183.10 valid=10s;
    resolver_timeout 5s;
    
    # #### Gzip compression ####
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml;
    
    # #### Health check ####
    location /health {
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
    
    # ============================================
    # COMMENTED OUT: Direct proxy_pass (causes startup failure)
    # ============================================
    # WHY COMMENTED: Nginx tries to resolve "api-gateway" hostname at startup
    # If the service isn't ready yet, nginx fails with "host not found" error
    # This causes CrashLoopBackOff in Kubernetes
    #
    # ORIGINAL CODE:
    # location /api {
    #     proxy_pass http://api-gateway:80;
    #     ...
    # }
    #
    # ============================================
    # WORKING FIX: Use variable in proxy_pass with resolver
    # ============================================
    # Proxy API requests to API Gateway
    # Handles relative URL (/api) from browser - proxies to internal API Gateway service
    # Works in all environments:
    # - Local dev: Browser → nginx → api-gateway:80
    # - Kubernetes: Browser → ingress → frontend nginx → api-gateway:80
    # - Production: Browser → ingress → frontend nginx → api-gateway:80
    #
    # HOW IT WORKS:
    # 1. Variable $api_gateway forces DNS resolution at REQUEST time (not startup)
    # 2. Resolver directive tells nginx which DNS server to use
    # 3. This prevents nginx from failing if api-gateway service isn't ready at startup
    location /api {
        # ============================================
        # COMMENTED OUT: Short service name (causes startup failure)
        # ============================================
        # WHY COMMENTED: Even with resolver + variable, nginx sometimes
        # tries to validate the upstream at startup if using short name
        #
        # ORIGINAL CODE:
        # set $api_gateway "http://api-gateway:80";
        #
        # ============================================
        # WORKING FIX: Use full FQDN with variable
        # ============================================
        # Full FQDN: api-gateway.payflow.svc.cluster.local
        # This ensures nginx uses DNS resolution at request time
        # The variable forces lazy evaluation (DNS lookup when request comes in)
        set $api_gateway "http://api-gateway.payflow.svc.cluster.local:80";
        proxy_pass $api_gateway;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect off;
        
        # Timeouts for better reliability
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # #### Cache static assets ####
    location ~* \.(js|css|png|jpg|svg|woff|woff2)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # #### SPA routing - serve index.html for all routes ####
    location / {
        try_files $uri $uri/ /index.html;
    }
}
