# #### PayFlow Auth Service ####
# #### This Service exposes the authentication service internally ####
apiVersion: v1  # #### Kubernetes API version ####
kind: Service  # #### Resource type - exposes pods to network traffic ####
metadata:
  name: auth-service  # #### Service name ####
  namespace: payflow  # #### Namespace ####
spec:
  selector:
    app: auth-service  # #### Select pods with this label ####
  ports:
  - protocol: TCP
    port: 3004  # #### Service port ####
    targetPort: 3004  # #### Container port ####
  type: ClusterIP  # #### Internal service (only accessible within cluster) ####

---
# #### PayFlow Auth Service Deployment ####
# #### This Deployment manages the authentication service pods ####
apiVersion: apps/v1  # #### Kubernetes API version ####
kind: Deployment  # #### Resource type - manages pod replicas ####
metadata:
  name: auth-service  # #### Deployment name ####
  namespace: payflow  # #### Namespace ####
spec:
  replicas: 2  # #### Number of pod replicas for high availability ####
  selector:
    matchLabels:
      app: auth-service  # #### Select pods with this label ####
  template:
    metadata:
      labels:
        app: auth-service  # #### Pod label ####
    spec:
      # Service account with IRSA annotation for AWS Secrets Manager access
      # serviceAccountName: auth-service  # #### Uncomment for AWS EKS with IRSA ####
      containers:
      - name: auth-service
        image: veeno/auth-service:latest  # #### Docker Hub image ####
        imagePullPolicy: IfNotPresent  # #### Pull from Docker Hub if not present locally ####
        securityContext:
          allowPrivilegeEscalation: false  # #### Prevent privilege escalation attacks ####
          runAsUser: 1000  # #### Run as UID 1000 (node user in Node.js images) ####
          runAsGroup: 1000  # #### Run as GID 1000 ####
          readOnlyRootFilesystem: false  # #### Allow writes (needed for logs, temp files) ####
        ports:
        - containerPort: 3004  # #### Container port ####
        env:
        # #### Database Configuration ####
        - name: DB_HOST
          valueFrom:
            configMapKeyRef:  # #### Get value from ConfigMap ####
              name: app-config
              key: DB_HOST
        - name: DB_PORT
          valueFrom:
            configMapKeyRef:
              name: app-config
              key: DB_PORT
        - name: DB_NAME
          valueFrom:
            configMapKeyRef:
              name: app-config
              key: DB_NAME
        - name: DB_USER
          valueFrom:
            secretKeyRef:  # #### Get value from Secret ####
              name: db-secrets
              key: DB_USER
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:  # #### Get password from Secret ####
              name: db-secrets
              key: DB_PASSWORD
        # #### Cache Configuration ####
        - name: REDIS_URL
          valueFrom:
            configMapKeyRef:
              name: app-config
              key: REDIS_URL
        # #### Security Configuration ####
        - name: JWT_SECRET
          valueFrom:
            secretKeyRef:  # #### Get JWT secret from Secret ####
              name: db-secrets
              key: JWT_SECRET
        #### Optional Configuration (uncomment if needed) ####
        - name: PORT
          value: "3004"  # #### Service port (defaults to 3004) ####
        - name: JWT_EXPIRES_IN
          value: "24h"  # #### JWT token expiration (defaults to 24h) ####
        - name: NODE_ENV
          value: "production"  # #### Node environment ####
        - name: SERVICE_NAME
          value: "auth-service"  # #### Service name for logging ####
        - name: CONTAINER_ENV
          value: "true"  # #### Enable container-aware logging ####
        resources:
          requests:  # #### Minimum resources required ####
            memory: "256Mi"  # #### Minimum memory ####
            cpu: "250m"      # #### Minimum CPU ####
          limits:  # #### Maximum resources allowed ####
            memory: "512Mi"  # #### Maximum memory ####
            cpu: "500m"      # #### Maximum CPU ####
        # #### Health Checks ####
        livenessProbe:  # #### Check if container is alive ####
          httpGet:
            path: /health  # #### Health check endpoint ####
            port: 3004     # #### Health check port ####
          initialDelaySeconds: 30  # #### Wait 30s before first check ####
          periodSeconds: 10       # #### Check every 10 seconds ####
        readinessProbe:  # #### Check if container is ready to serve traffic ####
          httpGet:
            path: /health  # #### Health check endpoint ####
            port: 3004     # #### Health check port ####
          initialDelaySeconds: 5  # #### Wait 5s before first check ####
          periodSeconds: 5       # #### Check every 5 seconds ####
