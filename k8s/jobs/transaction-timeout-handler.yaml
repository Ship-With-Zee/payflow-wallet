# ============================================
# Transaction Timeout Handler - Auto-Reverse Stuck Transactions
# ============================================
# Purpose: Automatically reverses pending transactions after 1 minute
# Why: Mimics real bank behavior - stuck/failed transactions are auto-reversed
# When: Runs every minute (CronJob)
# What happens without it: Pending transactions stay stuck forever, blocking user funds

# ============================================
# Kubernetes CronJob Configuration
# ============================================
apiVersion: batch/v1  # Kubernetes batch API version (for Jobs and CronJobs)
kind: CronJob  # Resource type - runs scheduled jobs repeatedly
# CronJob vs Job:
# - CronJob: Runs on a schedule (this one runs every minute)
# - Job: Runs once and completes
metadata:
  name: transaction-timeout-handler  # Unique name for this CronJob
  namespace: payflow  # Namespace where the CronJob will run
spec:
  # ============================================
  # Cron Schedule
  # ============================================
  # Run every minute
  schedule: "* * * * *"  # Cron format: minute hour day month day-of-week
  # Format breakdown:
  # * = minute (0-59) - every minute
  # * = hour (0-23) - every hour
  # * = day of month (1-31) - every day
  # * = month (1-12) - every month
  # * = day of week (0-7, where 0 and 7 = Sunday) - every day
  # Examples:
  # "0 2 * * *" = Every day at 2 AM
  # "*/5 * * * *" = Every 5 minutes
  # "0 0 * * 0" = Every Sunday at midnight
  
  # ============================================
  # Job History Limits
  # ============================================
  successfulJobsHistoryLimit: 3  # Keep last 3 successful jobs for debugging
  # Why: Helps troubleshoot if something goes wrong later
  # Old successful jobs are automatically deleted
  
  failedJobsHistoryLimit: 1      # Keep last 1 failed job for debugging
  # Why: Failed jobs are more important to keep for troubleshooting
  # Only keeps the most recent failure
  
  # ============================================
  # Job Template
  # ============================================
  # CronJob creates Jobs from this template
  # Each time the schedule triggers, a new Job is created
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            cronjob: transaction-timeout-handler  # Label for network policy
        spec:
          # ============================================
          # Restart Policy
          # ============================================
          restartPolicy: OnFailure  # Restart if job fails
          # If the SQL query fails, Kubernetes will retry
          # Once successful, job completes and doesn't restart
          
          # ============================================
          # DNS Configuration
          # ============================================
          dnsPolicy: ClusterFirst  # Use cluster DNS (CoreDNS)
          # Ensures proper DNS resolution for service discovery
          
          # ============================================
          # Container Configuration
          # ============================================
          containers:
          - name: transaction-timeout-container  # Container name
            image: postgres:15-alpine  # Use PostgreSQL client image (includes psql)
            # Why postgres image: Contains psql command-line tool we need
            
            # ============================================
            # Command and Arguments
            # ============================================
            command: ['sh', '-c']  # Run shell with -c flag
            args:
            - |
              # ============================================
              # Connect to PostgreSQL and Execute SQL
              # ============================================
              # << EOF: Here-document - passes SQL between EOF markers to psql
              # This allows multi-line SQL without escaping quotes
              # Uses PGDATABASE, PGUSER, PGPASSWORD env vars automatically
              # -h postgres: Connect to postgres service (Kubernetes DNS)
              psql -h postgres -U $PGUSER -d $PGDATABASE << EOF
              
              -- ============================================
              -- SQL: Auto-Reverse Stuck Transactions
              -- ============================================
              -- Purpose: Find pending transactions older than 1 minute and mark them as failed
              -- This mimics real bank behavior: stuck transactions are automatically reversed
              
              UPDATE transactions
              SET 
                -- Change status from PENDING to FAILED
                status = 'FAILED',
                
                -- Add error message explaining why it was reversed
                -- || is PostgreSQL string concatenation operator
                -- NOW() returns current timestamp
                error_message = 'Transaction timeout - automatically reversed by system (' || NOW() || ')',
                
                -- Set completion timestamp
                completed_at = CURRENT_TIMESTAMP,
                
                -- Set processing start time (use existing or fall back to created_at)
                -- COALESCE: Returns first non-NULL value
                processing_started_at = COALESCE(processing_started_at, created_at)
              
              WHERE 
                -- Only update transactions that are still pending
                status = 'PENDING' 
                
                -- Only update transactions older than 1 minute
                -- NOW() - INTERVAL '1 minute': Current time minus 1 minute
                -- created_at < ...: Transaction was created more than 1 minute ago
                AND created_at < NOW() - INTERVAL '1 minute';
                
              -- ============================================
              -- SQL: Count Reversed Transactions (for Logging)
              -- ============================================
              -- Purpose: Get count of transactions reversed in the last minute
              -- This helps monitor how many transactions are timing out
              SELECT COUNT(*) as reversed_count FROM transactions 
              WHERE status = 'FAILED'  -- Only failed transactions
              AND error_message LIKE '%automatically reversed%'  -- Only auto-reversed ones
              AND completed_at > NOW() - INTERVAL '1 minute';  -- Reversed in last minute
              -- LIKE: Pattern matching (case-sensitive)
              -- % = wildcard (matches any characters)
              
              EOF
              # End of here-document
              # psql executes all SQL between << EOF and EOF
              
            # ============================================
            # Environment Variables
            # ============================================
            # PostgreSQL client uses these environment variables automatically
            # PGDATABASE, PGUSER, PGPASSWORD, PGHOST are standard PostgreSQL env vars
            env:
            # Database name from ConfigMap (non-sensitive)
            - name: PGDATABASE
              valueFrom:
                configMapKeyRef:  # Get value from ConfigMap
                  name: app-config  # ConfigMap name
                  key: DB_NAME  # Key in ConfigMap
            # Database user from Secret (sensitive)
            - name: PGUSER
              valueFrom:
                secretKeyRef:  # Get value from Secret (encrypted at rest)
                  name: db-secrets  # Secret name
                  key: DB_USER  # Key in Secret
            # Database password from Secret (sensitive)
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:  # Get value from Secret
                  name: db-secrets  # Secret name
                  key: DB_PASSWORD  # Key in Secret
            # Note: psql automatically uses PGDATABASE, PGUSER, PGPASSWORD
            # No need to pass -d, -U flags
            
            # ============================================
            # Resource Limits (Required for Resource Quota)
            # ============================================
            resources:
              requests:
                cpu: "50m"       # Minimum CPU (small job, runs quickly)
                memory: "64Mi"   # Minimum memory (just runs psql)
              limits:
                cpu: "100m"      # Maximum CPU
                memory: "128Mi"  # Maximum memory

